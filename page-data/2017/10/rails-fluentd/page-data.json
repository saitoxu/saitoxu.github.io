{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/10/rails-fluentd","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"37126a9f-ed97-5271-b7f6-ea39f485c918","excerpt":"Rails のログを Fluentd で S3 に保存する方法を調べました。\n次のようにログの集約サーバを配置する構成で考えます。  集約サーバは CentOS7 系で進めます。 IAM ユーザの用意 S3 にログを保存するために、\n保存先のバケットへのアクセス権限を持つ IAM…","html":"<p>Rails のログを Fluentd で S3 に保存する方法を調べました。\n次のようにログの集約サーバを配置する構成で考えます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c29a8e2db628afa12e3c4241371d0d32/e5e39/2017-10-16-structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.82987141444115%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABcSAAAXEgFnn9JSAAABjklEQVQoz5VSPU8CQRC9v0OLvYm2/gEbKq2NpbHD8AdsDI0h+FXYKIkJRApCQSJGMAY0FhpCAspXvNvbu+P2vp6zh0eIeIWTzGXmdufNvDerBEEAYdtwXRfSZB55lP/HFMuyUCgUUG80AIojWwT+q8lS7vsygMJ1HfvpNG5SKfjFIiw6kBPHWVyT6Exx6HNXKqGTSAD9PmzKNVWFSm6aZigF5xyqpsGPoW8zDWI8mlH+gYbIZiHq9fklj4AkoGFwlG/LuLw4Q+Da8DwPQojQHdfDVFPxsLOF641V6J03KPJCv9cDo+IQW2oRdaYiqfHpSR57R+dovo8wHk1oYh2MMTBugA0+0djexNXaCr5eWlAkveNcDlWijeEQEk6CSMqySNAUfDLEYa2D3fwjdVymbBCoQdOFlCXgQSaD6vo6gkoF3HGgE5C/MKllmbhvveKp/YxutxNqGbsUj4KPZhODZBIeUQ9+bVSa1IvrDBrpxehVRGPOnw01j6SaLWU6hajV4LTbCEjTYPFyzGbj/n8DGf/0dWf1+RYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"構成\"\n        title=\"構成\"\n        src=\"/static/c29a8e2db628afa12e3c4241371d0d32/799d3/2017-10-16-structure.png\"\n        srcset=\"/static/c29a8e2db628afa12e3c4241371d0d32/00d96/2017-10-16-structure.png 148w,\n/static/c29a8e2db628afa12e3c4241371d0d32/0b23c/2017-10-16-structure.png 295w,\n/static/c29a8e2db628afa12e3c4241371d0d32/799d3/2017-10-16-structure.png 590w,\n/static/c29a8e2db628afa12e3c4241371d0d32/2a3d6/2017-10-16-structure.png 885w,\n/static/c29a8e2db628afa12e3c4241371d0d32/e5e39/2017-10-16-structure.png 1011w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>集約サーバは CentOS7 系で進めます。</p>\n<h2><strong>IAM ユーザの用意</strong></h2>\n<p>S3 にログを保存するために、\n保存先のバケットへのアクセス権限を持つ IAM ユーザを作成します。\n作成したらアクセスキー ID とシークレットキーを控えておきます。</p>\n<h2><strong>集約サーバの準備</strong></h2>\n<p>まずログの集約サーバの準備をします。</p>\n<h4>td-agent のインストール</h4>\n<p>はじめに td-agent をインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> -L https://toolbelt.treasuredata.com/sh/install-redhat-td-agent2.sh <span class=\"token operator\">|</span> <span class=\"token function\">sh</span></code></pre></div>\n<h4>プラグインのインストール</h4>\n<p>次にプラグインをインストールします。\nプラグインのインストールは<code>td-agent-gem</code>を使います。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> td-agent-gem <span class=\"token function\">install</span> fluent-plugin-forest</code></pre></div>\n<p><a href=\"https://github.com/tagomoris/fluent-plugin-forest\">fluent-plugin-forest</a>は\n<code>&#x3C;template></code>や<code>&#x3C;case></code>ディレクティブでマッチしたタグ名を使えるプラグインです。\nタグ名毎に出力するファイルを分けたいときなどに、設定が冗長にならずに済みます。\nちなみに Fluentd の最新バージョンである v0.14 ではプラグインなしでできるそうです。</p>\n<h4>環境変数の設定</h4>\n<p>IAM ユーザのアクセスキーなどは環境変数として設定して、\nそれを td-agent の設定ファイルから読むことにします。\n環境変数はこちらの方法を使って設定します。</p>\n<p><a href=\"http://inokara.hateblo.jp/entry/2016/09/17/091659\">td-agent.conf 設定パラメータの値を環境変数から参照したい - ようへいの日々精進 XP</a></p>\n<p><code>/etc/sysconfig/td-agent</code>は設定後、次のようになると思います。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">S3_BUCKET</span><span class=\"token operator\">=</span>test.bucket <span class=\"token comment\"># ログを保存するS3のバケット</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_KEY_ID</span><span class=\"token operator\">=</span>ABCDEFGHIJKLMNOPQRST <span class=\"token comment\"># 上記バケットへのアクセスを持つIAMユーザのキー</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_SEC_KEY</span><span class=\"token operator\">=</span>abcdefghijklmnopqrstuvwxyz1234567890ABCD <span class=\"token comment\"># 上記IAMユーザのシークレットトークン</span></code></pre></div>\n<h4>設定ファイルの作成</h4>\n<p>設定ファイルはたとえば次のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&lt;</span>source<span class=\"token operator\">></span>\n  @type forward\n  port <span class=\"token number\">24224</span>\n  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0\n<span class=\"token operator\">&lt;</span>/source<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>match *.**<span class=\"token operator\">></span>\n  @type forest\n  subtype s3\n  <span class=\"token operator\">&lt;</span>template<span class=\"token operator\">></span>\n    aws_key_id <span class=\"token string\">\"#{ENV['AWS_KEY_ID']}\"</span>\n    aws_sec_key <span class=\"token string\">\"#{ENV['AWS_SEC_KEY']}\"</span>\n    s3_bucket <span class=\"token string\">\"#{ENV['S3_BUCKET']}\"</span>\n    s3_region ap-northeast-1\n\n    path\n    buffer_path /var/log/td-agent/buffer/<span class=\"token variable\">${tag}</span>\n    time_slice_format %Y/%m/%d/<span class=\"token variable\">${tag}</span>/ec2-%Y-%m-%d-%H\n    retry_wait 30s\n    retry_limit <span class=\"token number\">5</span>\n    flush_interval 1h\n    flush_at_shutdown <span class=\"token boolean\">true</span>\n  <span class=\"token operator\">&lt;</span>/template<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/match<span class=\"token operator\">></span></code></pre></div>\n<p>これにて集約サーバの設定は完了です。</p>\n<h2><strong>Rails の設定</strong></h2>\n<p>次に Rails の設定をしていきます。</p>\n<h4>gem のインストール</h4>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># Gemfile</span>\ngem <span class=\"token string\">'act-fluent-logger-rails'</span></code></pre></div>\n<p><a href=\"https://github.com/actindi/act-fluent-logger-rails\">act-fluent-logger-rails</a>は\nログを Fluentd に流すための gem です。\nカスタマイズ性は低いですが、\n取り急ぎ Fluentd にログを流したいときにサッと使えるので今回はこれを使っていきます。</p>\n<h4>設定ファイルの更新</h4>\n<p><code>application.rb</code>や<code>production.rb</code>などの環境毎の設定ファイルを更新します。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># config/environments/production.rb</span>\n<span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>configure <span class=\"token keyword\">do</span>\n  <span class=\"token comment\"># ...</span>\n\n  config<span class=\"token punctuation\">.</span>logger <span class=\"token operator\">=</span> <span class=\"token constant\">ActFluentLoggerRails</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Logger</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>\n      log_tags<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        ip<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:ip</span><span class=\"token punctuation\">,</span>\n        ua<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:user_agent</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n  config<span class=\"token punctuation\">.</span>lograge<span class=\"token punctuation\">.</span>enabled <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span>\n  config<span class=\"token punctuation\">.</span>lograge<span class=\"token punctuation\">.</span>formatter <span class=\"token operator\">=</span> <span class=\"token constant\">Lograge</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Formatters</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Json</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\n\n  <span class=\"token comment\"># ...</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h4><code>config/fluent-logger.yml</code>の追加</h4>\n<p>集約サーバの設定を追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">production</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">fluent_host</span><span class=\"token punctuation\">:</span> &lt;%= ENV<span class=\"token punctuation\">[</span><span class=\"token string\">'FLUENT_HOST'</span><span class=\"token punctuation\">]</span> %<span class=\"token punctuation\">></span>\n  <span class=\"token key atrule\">fluent_port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">24224</span>\n  <span class=\"token key atrule\">tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sample.tag\"</span>\n  <span class=\"token key atrule\">messages_type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"string\"</span></code></pre></div>\n<p>以上で Rails の設定も完了です。\nこれで集約サーバを介して S3 にログが保存されるようになります。</p>","frontmatter":{"title":"FluentdでRailsのログをS3に保存する","date":"October 16, 2017","tags":["Rails","Fluentd"],"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQoz4VSMUvDQBjN4OxfcBd/grP+CUdx1MXFzVlxUxBxkyIIipVW61AHhWrRCtqCXWxpm8TEqDRNTVpzd880jTGXnPaDI3fve/e+78s9CZFgjIVfRil3DnHBPhqSUIyQGI2/TCjzVrKgWNAj+pfUJlylEeSGnDeHoN3ni8W7lKLt/4jZ50fQZybRTW2DffVBA/K90cNiXkWhYeLytgbd6CTG/+0wEKPtD2jTEzDXVoa4N/6A7Ab55asXjC0cY2n1EJbliAW57k720RyX0N3bGlbycEppONJ8uoq5zevBbxWOLcUfws4eQJ+dgrWzDtoxQR3bx1VVRfmpimflFarchKzIeKxUoGkaJ5oQ7BXysHY34Fxk8JlOgbwbPt5qtXBXKqFYvEE2l8NDuYzM6Rlq9XowCOUF4637PnTdBE4IFfr2fx9GhUeYOnQI98p/ENgIPJ4fxDfPYkuLviRSEwAAAABJRU5ErkJggg==","width":1200,"height":630,"src":"/static/8b28ae4c40cc6b44cba9c2496bd767a9/e7e81/2017-10-16-ogp.png","srcSet":"/static/8b28ae4c40cc6b44cba9c2496bd767a9/e7e81/2017-10-16-ogp.png 1x"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/10/rails-fluentd","previous":{"fields":{"slug":"/2017/10/popular-posts"},"frontmatter":{"title":"はてなブックマークの人気エントリーをAPI GatewayとLambdaを使って取得する","tags":["Amazon API Gateway","AWS Lambda","React"]}},"next":{"fields":{"slug":"/2017/11/redis-rails"},"frontmatter":{"title":"RailsのセッションをRedisに保存する (1)","tags":["Rails","Redis"]}}}}}