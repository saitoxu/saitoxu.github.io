{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/10/popular-posts","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"6f7901d0-aa5c-5d55-bf5a-b879e399d4b1","excerpt":"このブログの人気エントリーを表示しようと、\nはてなブックマークの人気エントリーをAmazon API GatewayとAWS Lambda…","html":"<p>このブログの人気エントリーを表示しようと、\nはてなブックマークの人気エントリーを<a href=\"http://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/welcome.html\">Amazon API Gateway</a>と<a href=\"http://docs.aws.amazon.com/ja_jp/lambda/latest/dg/welcome.html\">AWS Lambda</a>を使って取得しました。</p>\n<p>フッター部分にこのブログの人気エントリーを表示しています。</p>\n<h2><strong>はてなブックマークの人気エントリーを取得する</strong></h2>\n<p>まず最初にはてなブックマークの人気エントリーを取得します。\n人気エントリーの検索は以下のようなエンドポイントを叩くと取得できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> <span class=\"token string\">'http://b.hatena.ne.jp/entrylist/json?url=saitoxu.io&amp;threshold=1&amp;sort=count'</span>\n<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"link\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"https://saitoxu.io/hoge\"</span>,<span class=\"token string\">\"count\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1\"</span>,<span class=\"token string\">\"title\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"hoge\"</span><span class=\"token punctuation\">}</span>, <span class=\"token punctuation\">..</span>. <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>で、エントリーを取得したら以前（<a href=\"/2017/07/jekyll-archive-preact\">preact を使ってブログのアーカイブメニューを作る | yosuke.saito</a>）やったように React のサブセット実装である<a href=\"https://preactjs.com/\">preact</a>を使って表示すればいいかと思ったんですがいくつか問題があります。</p>\n<p><strong>問題</strong></p>\n<ol>\n<li><strong>CORS で直接 JS から API を叩けない</strong> このブログのドメインが許可されていないので直接 JavaScript から API は呼べないと。</li>\n<li><strong>JSONP で呼び出そうとしても API が HTTP しか対応していない</strong> で、そのときにどうするかということで\nJSONP での呼び出しに対応しているみたいなんですが、そもそも HTTP しかないみたいで HTTPS なサイトでは使えない。</li>\n</ol>\n<p>でどうしようかと思いまして、今回は API Gateway と Lambda を使って解決することにしました。</p>\n<h2><strong>Lambda の関数を作る</strong></h2>\n<p>まず Lambda で、はてブのエントリーを取得してそれを返すだけの関数を作ります。\nランタイム環境は Node.js 6.10 を選んだので JavaScript で書いてます。\n次の記事が参考になりました。</p>\n<p><a href=\"https://qiita.com/n0bisuke/items/788dc4379fd57e8453a3\">Node.js で HTTP GET して JSON パースするメモ - Qiita</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    hostname<span class=\"token punctuation\">:</span> <span class=\"token string\">\"b.hatena.ne.jp\"</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token punctuation\">:</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token punctuation\">:</span> <span class=\"token string\">\"/entrylist/json?url=saitoxu.io&amp;threshold=1&amp;sort=count\"</span><span class=\"token punctuation\">,</span>\n    headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"user-agent\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hogehoge\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> body <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">setEncoding</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"utf8\"</span><span class=\"token punctuation\">)</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">chunk</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      body <span class=\"token operator\">+=</span> chunk\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      ret <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> ret<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意点としては、はてブの API は User Agent を指定しないと<code>500</code>エラーが返ってくるので適当に指定する必要があります。\nあと、JSONP のためにレスポンスボディが<code>([body]);</code>のように丸括弧で囲われており、\nそのまま json にパースするとエラーになるので括弧を削除してます。</p>\n<h2><strong>API Gateway で Lambda を呼ぶ API を作る</strong></h2>\n<p>API Gateway を使って先ほど作った Lambda を呼ぶ API を作ります。\n特に詰まるところはないと思いますが、強いてあげるなら CORS の設定をちゃんとしましょうということくらいでしょうか。</p>\n<p>あと API Gateway は若干料金が発生するので、一応 API キーを設定して、\n一定期間当たりの使用回数に上限を設けて不当に呼び出されていないか監視するようにはしています。\nあんまりお金がかかるようなら別の方法を検討します笑</p>\n<p>以上、はてブの人気エントリーの表示方法でした。\n思ったより時間かけてしまったんですが汗、久々に Lambda など触る機会を持てたのは良かったです。</p>","frontmatter":{"title":"はてなブックマークの人気エントリーをAPI GatewayとLambdaを使って取得する","date":"October 12, 2017","tags":["Amazon API Gateway","AWS Lambda","React"],"ogp":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/10/popular-posts","previous":{"fields":{"slug":"/2017/10/blog-first-anniversary"},"frontmatter":{"title":"ブログを続けて1年が経ちました","tags":["Daily"]}},"next":{"fields":{"slug":"/2017/10/rails-fluentd"},"frontmatter":{"title":"FluentdでRailsのログをS3に保存する","tags":["Rails","Fluentd"]}}}}}