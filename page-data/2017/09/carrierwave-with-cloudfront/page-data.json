{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/09/carrierwave-with-cloudfront","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"88d653eb-099a-51c7-8a70-e65ecc57e5c3","excerpt":"Rails で CarrierWave+Fog を使って画像などのリソースを S3 に保存し、\nそれを CloudFront 経由で配信するとき、ちょっと困ったことがあったのでメモしておきます。 環境は次のとおりです。 Rails 5.1.1 CarrierWave 1.1.0 Fog 1.40.…","html":"<p>Rails で CarrierWave+Fog を使って画像などのリソースを S3 に保存し、\nそれを CloudFront 経由で配信するとき、ちょっと困ったことがあったのでメモしておきます。</p>\n<p>環境は次のとおりです。</p>\n<ul>\n<li>Rails 5.1.1</li>\n<li>CarrierWave 1.1.0</li>\n<li>Fog 1.40.0</li>\n</ul>\n<h2><strong>問題</strong></h2>\n<p>セキュリティのため S3 に保存したリソースへの直接アクセスは禁止し、\nCloudFront からのみのアクセスを許可したいという要求があります。</p>\n<p>これを実現するには、CarrierWave の設定を次のようにすればできそうな気がします。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># config/initializers/carrierwave.rb</span>\n<span class=\"token constant\">CarrierWave</span><span class=\"token punctuation\">.</span>configure <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>config<span class=\"token operator\">|</span>\n  config<span class=\"token punctuation\">.</span>storage <span class=\"token operator\">=</span> <span class=\"token symbol\">:fog</span>\n  config<span class=\"token punctuation\">.</span>fog_credentials <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    provider<span class=\"token punctuation\">:</span> <span class=\"token string\">'AWS'</span><span class=\"token punctuation\">,</span>\n    aws_access_key_id<span class=\"token punctuation\">:</span> <span class=\"token string\">'ABCDEFGHIJKLMNOPQRST'</span><span class=\"token punctuation\">,</span>\n    aws_secret_access_key<span class=\"token punctuation\">:</span> <span class=\"token string\">'abcdefghijklmnopqrstuvwxyz1234567890ABCD'</span><span class=\"token punctuation\">,</span>\n    region<span class=\"token punctuation\">:</span> <span class=\"token string\">'ap-northeast-1'</span><span class=\"token punctuation\">,</span>\n    path_style<span class=\"token punctuation\">:</span> <span class=\"token keyword\">true</span>\n  <span class=\"token punctuation\">}</span>\n  config<span class=\"token punctuation\">.</span>fog_public <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n  config<span class=\"token punctuation\">.</span>fog_attributes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Cache-Control'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'public, max-age=86400'</span> <span class=\"token punctuation\">}</span>\n  config<span class=\"token punctuation\">.</span>remove_previously_stored_files_after_update <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n  config<span class=\"token punctuation\">.</span>fog_directory <span class=\"token operator\">=</span> <span class=\"token string\">'bucket-example'</span>\n  config<span class=\"token punctuation\">.</span>asset_host <span class=\"token operator\">=</span> <span class=\"token string\">'https://abcdefghijklmn.cloudfront.net'</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>しかし、実際に<code>model.resource.url</code>のようにアクセスすると、\n以下のような S3 の Pre-Signed URL が返ってきます。</p>\n<p><code>https://bucket-example.s3.amazonaws.com/uploads/user/image/1/image.jpeg?X-Amz-Expires=60&#x26;X-Amz-Date=20160914T044238Z&#x26;X-Amz-Algorithm=AWS4-HMAC-SHA256&#x26;X-Amz-Credential=AKIAJTIEVPQZEXU26EJA/20160914/us-east-1/s3/aws4_request&#x26;X-Amz-SignedHeaders=host&#x26;X-Amz-Signature=53daea895d9b40d5821011ee0e4c776c0ab96bdce5f14d078716f40a2e723244</code></p>\n<p>古いですが以下の Issue などを見たところ、\nAWS Specific な課題なので CarrierWave の方で対応はされていないようです。</p>\n<p><a href=\"https://github.com/carrierwaveuploader/carrierwave/issues/1158\">Using CloudFront CDN for private files · Issue #1158 · carrierwaveuploader/carrierwave</a></p>\n<h2><strong>解決方法</strong></h2>\n<p>安直ですが各 Uploader の<code>url</code>メソッドをオーバーライドして CloudFront の URL を返すようにします。</p>\n<p>CloudFront のドメインは<a href=\"https://github.com/railsconfig/config\">railsconfig/config</a>を使って定義していて、\n加えて以下の工夫を加えています。</p>\n<ul>\n<li><code>default_url</code>が定義されているときはそれを返す</li>\n<li>開発・テスト環境と本番環境で場合分け</li>\n<li>リソースを更新したあとはキャッシュクリアしたいので更新日時をクエリパラメータに追加</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ResourceUploader</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">CarrierWave</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Uploader</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n\n  <span class=\"token comment\"># rest of uploader</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">url</span></span>\n    <span class=\"token keyword\">if</span> path<span class=\"token punctuation\">.</span>present<span class=\"token operator\">?</span>\n      <span class=\"token comment\"># 保存先がローカルの場合</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token keyword\">super</span><span class=\"token delimiter tag\">}</span></span>?updatedAt=<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>model<span class=\"token punctuation\">.</span>updated_at<span class=\"token punctuation\">.</span>to_i<span class=\"token delimiter tag\">}</span></span>\"</span> <span class=\"token keyword\">if</span> <span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span>development<span class=\"token operator\">?</span> <span class=\"token operator\">||</span> <span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span>test<span class=\"token operator\">?</span>\n      <span class=\"token comment\"># 保存先がS3の場合</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">Settings</span><span class=\"token punctuation\">.</span>asset_host<span class=\"token delimiter tag\">}</span></span>/<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>path<span class=\"token delimiter tag\">}</span></span>?updatedAt=<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>model<span class=\"token punctuation\">.</span>updated_at<span class=\"token punctuation\">.</span>to_i<span class=\"token delimiter tag\">}</span></span>\"</span>\n    <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">super</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>あと次のような解決方法もあるみたいです。</p>\n<p><a href=\"https://stackoverflow.com/questions/9956712/use-cdn-with-carrierwave-fog-in-s3-cloudfront-with-rails-3-1\">amazon s3 - Use CDN with carrierwave + fog in s3 + cloudfront with rails 3.1 - Stack Overflow</a></p>\n<p>以上、CarrierWave+Fog でリソースを S3 に保存・CloudFront で配信するときの小ネタでした。</p>","frontmatter":{"title":"CarrierWave+FogでリソースをS3に保存・CloudFrontで配信するときの小ネタ","date":"September 13, 2017","tags":["Rails","Amazon S3","CloudFront"],"ogp":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/09/carrierwave-with-cloudfront","previous":{"fields":{"slug":"/2017/08/instagram-clone"},"frontmatter":{"title":"React NativeでInstagramのクローンを作ってみた","tags":["React Native"]}},"next":{"fields":{"slug":"/2017/09/sendbird-sample"},"frontmatter":{"title":"手軽にチャット機能を作れるSendBirdを試してみた","tags":["JavaScript","React Native","SendBird"]}}}}}