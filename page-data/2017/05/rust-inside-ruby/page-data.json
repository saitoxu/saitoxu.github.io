{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/05/rust-inside-ruby","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"5d0230cf-6f9b-5797-bd73-ed65e066b688","excerpt":"最近趣味で Rust を勉強しています。 まだ公式サイトを読んだり写経してる程度ですが、並列処理の性能は期待できますね。 今回は他言語(Ruby)から Rust を呼び出して、並列性能の恩恵に与るというのをやってみます。 Rust の公式サイトの 3.3 節の内容になります。 Rust Inside Other…","html":"<p>最近趣味で Rust を勉強しています。</p>\n<p>まだ公式サイトを読んだり写経してる程度ですが、並列処理の性能は期待できますね。</p>\n<p>今回は他言語(Ruby)から Rust を呼び出して、並列性能の恩恵に与るというのをやってみます。</p>\n<p>Rust の公式サイトの 3.3 節の内容になります。</p>\n<p><a href=\"https://rust-lang-ja.github.io/the-rust-programming-language-ja/1.6/book/rust-inside-other-languages.html\">Rust Inside Other Languages</a></p>\n<h2><strong>1. 問題</strong></h2>\n<p>次のようなプログラムを書いてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">10スレッドでそれぞれ1から5,000,000までの数字をカウントして、\n全部のスレッドでカウントが終了したら'done!'と表示する。</code></pre></div>\n<h2><strong>2. Ruby で書く</strong></h2>\n<p>Ruby で書くと次のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">threads <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token number\">10.</span>times <span class=\"token keyword\">do</span>\n  threads <span class=\"token operator\">&lt;</span><span class=\"token operator\">&lt;</span> <span class=\"token builtin\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">do</span>\n    count <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    <span class=\"token number\">5</span>_000_000<span class=\"token punctuation\">.</span>times <span class=\"token keyword\">do</span>\n      count <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n    <span class=\"token keyword\">end</span>\n\n    count\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\nthreads<span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>t<span class=\"token operator\">|</span>\n  puts <span class=\"token string\">\"Thread finished with count=<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>t<span class=\"token punctuation\">.</span>value<span class=\"token delimiter tag\">}</span></span>\"</span>\n<span class=\"token keyword\">end</span>\nputs <span class=\"token string\">\"done!\"</span></code></pre></div>\n<p>これを実行すると、自分の手元の PC では <strong>2.286s</strong> かかりました。</p>\n<h2><strong>3. Rust で書く</strong></h2>\n<p>同じプログラムを Rust で書いてみます。</p>\n<p>Rust と Rust のパッケージマネージャである Cargo はインストール済みとします。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ cargo new embed <span class=\"token comment\"># プロジェクト作成</span>\n$ <span class=\"token builtin class-name\">cd</span> embed\n$ <span class=\"token function\">ls</span> src/\nlib.rs <span class=\"token comment\"># これを編集する</span></code></pre></div>\n<p><code>lib.rs</code>は次のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">use</span> std<span class=\"token punctuation\">::</span>thread<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> handles<span class=\"token punctuation\">:</span> Vec<span class=\"token operator\">&lt;</span>_<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n        thread<span class=\"token punctuation\">::</span><span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">5_000_000</span> <span class=\"token punctuation\">{</span>\n                x <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n            <span class=\"token punctuation\">}</span>\n            x\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> h <span class=\"token keyword\">in</span> handles <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thread finished with count={}\"</span><span class=\"token punctuation\">,</span>\n            h<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map_err</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>_<span class=\"token operator\">|</span> <span class=\"token string\">\"Could not join a thread!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>この関数を Ruby から呼び出してみましょう。</p>\n<h2><strong>4. Ruby から Rust を呼び出す</strong></h2>\n<p>Ruby から他言語のプログラムを呼ぶには、\nFFI(Foreign Function Interface)というインターフェースにのっとります。</p>\n<p>日本語だと以下の記事が詳しいです。</p>\n<p><a href=\"http://kazegusuri.hateblo.jp/entry/2014/03/02/192729\">Ruby FFI を使ったエクステンションの作り方 - Boost Your Programming!</a></p>\n<p>FFI の実装は gem で提供されているので、<code>gem install ffi</code>でインストールして使います。</p>\n<p>次に Rust のプログラムを外から呼び出せるようライブラリ化しましょう。</p>\n<p>そのためには、上記のプログラムの次の部分を</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p>このように変更します。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p>もう一つ、プロジェクトトップにある<code>Cargo.toml</code>に次の 3 行を追加して、</p>\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">lib</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"embed\"</span>\n<span class=\"token key property\">crate-type</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"dylib\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><code>cargo build --release</code>でビルドすれば完了です。</p>\n<p><code>target/release</code>以下に<code>libembed.so</code>という共有ライブラリができていると思うので、\nこれを FFI を使って Ruby から呼び出します。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string\">'ffi'</span>\n\n<span class=\"token keyword\">module</span> <span class=\"token constant\">Hello</span>\n  extend <span class=\"token constant\">FFI</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Library</span>\n  ffi_lib <span class=\"token string\">'target/release/libembed.so'</span>\n  attach_function <span class=\"token symbol\">:process</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:void</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token constant\">Hello</span><span class=\"token punctuation\">.</span>process\n\nputs <span class=\"token string\">'done!'</span></code></pre></div>\n<p>これを実行すると、同じ環境で <strong>0.109s</strong> で完了しました。</p>\n<p>Rust 速いですね。</p>\n<h2><strong>5. おわりに</strong></h2>\n<p>以上、Ruby から Rust を呼び出してみました。</p>\n<p>まだちょっとしか触ってませんが、この速さと安全性は良いなと思います。</p>\n<p>今後も継続して試していこうと思います。</p>","frontmatter":{"title":"RubyからRustを呼び出す","date":"May 24, 2017","tags":["Rust","Ruby"],"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQoz41SvcqDQBDMS6TUWrQJYmNtZ5EyaG2hNmnsBMFKyCOkENT3sDDig2il6BsYM+EO7uPy8xkHlr2D2bnd2dvhDY/HgwbBsiw0GPg7z+Ox+ybIihm6rkPbti/CPHdVkC+YpglBEMBxHBqu66Lv+48Hf3bIXjZNE4qi4HK5IEkSeJ4H27Y/plkVvN/vNDdNA8MwcDgcIEkSRFGE7/uwLAtlWb5wNwkWRYHz+Yzj8QhVVaFpGh37dDohz3PKmef5tyDzZhxHCIJAR47jGFVVQZZl7Pd7DMPwr49fPWRE0qWu67her0jTlJ6zLPsT27xlfjF1XSOKIoRhiNvttvoHV/8h3+m7JTxnc4cskyUR80mQ85oYwRPfmyAsRYGRygAAAABJRU5ErkJggg==","width":1200,"height":630,"src":"/static/5b6cb6f5fc6e7b101e0e144b9b192e89/e7e81/2017-05-24-ogp.png","srcSet":"/static/5b6cb6f5fc6e7b101e0e144b9b192e89/e7e81/2017-05-24-ogp.png 1x"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/05/rust-inside-ruby","previous":{"fields":{"slug":"/2017/05/react-form-data"},"frontmatter":{"title":"JavaScriptでフォームデータを送信する","tags":["JavaScript"]}},"next":{"fields":{"slug":"/2017/05/rust-feature"},"frontmatter":{"title":"Rustのメモリ安全性を支える3つの概念","tags":["Rust"]}}}}}