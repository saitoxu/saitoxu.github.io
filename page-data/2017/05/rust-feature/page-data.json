{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/05/rust-feature","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"07b3bcb2-a8bf-5904-88aa-f45edc69b26f","excerpt":"Rust のメモリ安全性を支える 3 つの概念、\n所有権 ・ 借用 ・ ライフタイム\nについて自分なりにざっくりまとめてみました。 まだ学習途中であるため、間違いがあるかもしれません。\nそのときは Twitter か何かでご指摘頂けると幸いです。 所有権 Rust ではリソースに対して同時に…","html":"<p>Rust のメモリ安全性を支える 3 つの概念、\n<strong>所有権</strong> ・ <strong>借用</strong> ・ <strong>ライフタイム</strong>\nについて自分なりにざっくりまとめてみました。</p>\n<p>まだ学習途中であるため、間違いがあるかもしれません。\nそのときは Twitter か何かでご指摘頂けると幸いです。</p>\n<h2><strong>所有権</strong></h2>\n<p>Rust ではリソースに対して同時に 1 人の所有者しか保持できず、\nその権利を <strong>所有権</strong> といいます。</p>\n<p>たとえば以下のコードを考えてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span> <span class=\"token function\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> v2 <span class=\"token operator\">=</span> v<span class=\"token punctuation\">;</span></code></pre></div>\n<p>このとき、もともと<code>v</code>が持っていたベクタのリソースに対する\n所有権が<code>v2</code>に移る（ムーブする）ことを表しています。</p>\n<p>所有権を失効した変数はスコープ内であっても使えません。\nこれにより Rust はリソースに対して同時に 1 つの参照しかないことを保証し、\nダングリングポインタ（不正なメモリ領域を指すポインタ）の発生を防いでいます。</p>\n<p>関数の仮引数に渡すときも、所有権は仮引数に移ることになります。\n元の変数は使うことはできません。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">take</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">:</span> Vec<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"take {}\"</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span> <span class=\"token function\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">take</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Error: use of moved value: `v`</span></code></pre></div>\n<p>ただし、プリミティブ型に代表される<code>Copy</code>トレイトを実装した型は\n所有権を移してもリソースがコピーされるので元の変数が使えます。</p>\n<p>ちなみにトレイト<a href=\"#f1\">*1</a>は「その型が実装しなければならないメソッドの集まり・実装」のことです。</p>\n<h2><strong>借用</strong></h2>\n<p>借用は所有権を移すことなく、リソースを一時的に借りることをいいます。</p>\n<p>コンパイル時に借用チェッカが、借用による参照先のオブジェクトが有効であるかを検査します。</p>\n<p>借用には 2 種類あって、イミュータブルな<code>&#x26; T</code>とミュータブルな<code>&#x26;mut T</code>があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function\">take</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Vec<span class=\"token operator\">&lt;</span>i32<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"take {}\"</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span> <span class=\"token function\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 使える</span></code></pre></div>\n<p>また、借用には以下のルールがあります。</p>\n<ul>\n<li>所有者のスコープより長く存続してはいけない</li>\n<li>\n<p>以下の 2 種類のどちらか 1 つを持つことはあるが、両方を同時には持てない</p>\n<ul>\n<li>リソースに対する 1 つ以上の参照（<code>&#x26;T</code>）</li>\n<li>ただ 1 つのミュータブルな参照（<code>&#x26;mut T</code>）</li>\n</ul>\n</li>\n</ul>\n<h2><strong>ライフタイム</strong></h2>\n<p>ライフタイムは借用の基礎となる概念で、借用した参照の有効期限のことをいいます。\n参照の有効期限を設定することで、\nリソース解放後の参照などのエラーをコンパイル時に検出できるようになります。</p>\n<p>ライフタイムは以下のように指定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> bar<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token lifetime-annotation symbol\">'a</span> i32<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>'a</code>をライフタイム a と呼びます。\n関数だけでなく、構造体が参照を持つ場合にもライフタイムを指定する必要があります。</p>\n<p>ライフタイムを越えた参照を使うことはできません。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> Foo<span class=\"token operator\">&lt;</span><span class=\"token lifetime-annotation symbol\">'a</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    x<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token lifetime-annotation symbol\">'a</span> i32<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> x<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> f <span class=\"token operator\">=</span> Foo <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">:</span> y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        x <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>f<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span> <span class=\"token comment\">// fがxより先にスコープから抜けてしまうので、コンパイルエラーが起きる</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2><strong>おわりに</strong></h2>\n<p>所有権・借用・ライフタイムについてざっくりまとめました。\n特にライフタイムの理解が難しく、まだ全然使えそうにないです。\n今後も継続して勉強していきます。</p>\n<p>関係ないですが、この「<a href=\"https://hayato.io/2017/faq/#rust\">Rust のよいところを教えてください</a>」を\n読むと学ぶモチベーションになります。</p>\n<p><a name=\"f1\">*1</a> トレイト - Wikipedia (<a href=\"https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%AC%E3%82%A4%E3%83%88\">https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%AC%E3%82%A4%E3%83%88</a>)</p>","frontmatter":{"title":"Rustのメモリ安全性を支える3つの概念","date":"May 27, 2017","tags":["Rust"],"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQoz41SvcqDQBDMS6TUWrQJYmNtZ5EyaG2hNmnsBMFKyCOkENT3sDDig2il6BsYM+EO7uPy8xkHlr2D2bnd2dvhDY/HgwbBsiw0GPg7z+Ox+ybIihm6rkPbti/CPHdVkC+YpglBEMBxHBqu66Lv+48Hf3bIXjZNE4qi4HK5IEkSeJ4H27Y/plkVvN/vNDdNA8MwcDgcIEkSRFGE7/uwLAtlWb5wNwkWRYHz+Yzj8QhVVaFpGh37dDohz3PKmef5tyDzZhxHCIJAR47jGFVVQZZl7Pd7DMPwr49fPWRE0qWu67her0jTlJ6zLPsT27xlfjF1XSOKIoRhiNvttvoHV/8h3+m7JTxnc4cskyUR80mQ85oYwRPfmyAsRYGRygAAAABJRU5ErkJggg==","width":1200,"height":630,"src":"/static/5b6cb6f5fc6e7b101e0e144b9b192e89/e7e81/2017-05-24-ogp.png","srcSet":"/static/5b6cb6f5fc6e7b101e0e144b9b192e89/e7e81/2017-05-24-ogp.png 1x"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/05/rust-feature","previous":{"fields":{"slug":"/2017/05/rust-inside-ruby"},"frontmatter":{"title":"RubyからRustを呼び出す","tags":["Rust","Ruby"]}},"next":{"fields":{"slug":"/2017/06/google-cloud-vision-ocr"},"frontmatter":{"title":"Google Cloud VisionでOCR","tags":["Google Cloud"]}}}}}