{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/11/redis-rails","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"5c31ae68-6d06-5d73-9ee5-5b954915ff28","excerpt":"デプロイ中にセッションを飛ばさないために、\nセッションをアプリケーション外に保存するケースがあります。\n今回はそういったケースのために、\nRails のセッションを Redis に保存できる\nredis-store/redis-rails\nを使ってみました。 まずは素の Rails…","html":"<p>デプロイ中にセッションを飛ばさないために、\nセッションをアプリケーション外に保存するケースがあります。\n今回はそういったケースのために、\nRails のセッションを Redis に保存できる\n<a href=\"https://github.com/redis-store/redis-rails\">redis-store/redis-rails</a>\nを使ってみました。</p>\n<h2><strong>まずは素の Rails プロジェクトを作成</strong></h2>\n<p>まずは素の Rails プロジェクトを作成します。\n最初のウェルカムページだけだとセッションが生成されないので、\n今回は Todo 管理システムを作るということにして、\nScaffold を使っていきます。\nちなみに Rails のバージョンは 5.1.4 を使っていきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ rails new redis-rails-sample --skip-bundle --skip-turbolinks\n$ <span class=\"token builtin class-name\">cd</span> redis-rails-sample\n$ bundle <span class=\"token function\">install</span> --path vendor/bundle\n$ rails g scaffold Task title:string status:integer</code></pre></div>\n<h2><strong>redis-rails をインストール</strong></h2>\n<p>次に<a href=\"https://github.com/redis-store/redis-rails\">redis-store/redis-rails</a>を\nインストールして設定を書いていきます。\nGemfile に<code>gem 'redis-rails'</code>と書いて、<code>bundle install</code>を実行します。</p>\n<p>次に<code>config/application.rb</code>を以下のように編集します。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">module</span> <span class=\"token constant\">RedisRailsSample</span>\n  <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">Rails</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Application</span>\n    <span class=\"token comment\"># ...</span>\n\n    <span class=\"token comment\"># これを追記</span>\n    config<span class=\"token punctuation\">.</span>cache_store <span class=\"token operator\">=</span> <span class=\"token symbol\">:redis_store</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"redis://localhost:6379/0/cache\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> expires_in<span class=\"token punctuation\">:</span> <span class=\"token number\">90.</span>minutes <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>最後に<code>config/initializers/session_store.rb</code>というファイルを作成し、\n以下の内容にします。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">RedisRailsSample</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Application</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>session_store <span class=\"token symbol\">:redis_store</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  servers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      host<span class=\"token punctuation\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n      port<span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span>\n      db<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      namespace<span class=\"token punctuation\">:</span> <span class=\"token string\">\"session\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"_<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>parent_name<span class=\"token punctuation\">.</span>downcase<span class=\"token delimiter tag\">}</span></span>_session\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2><strong>Redis にセッションが保存されるか確認</strong></h2>\n<p>ローカルで Redis と Rails を立ち上げて、ブラウザで\n<code>http://localhost:3000/tasks</code>にアクセスしてみましょう。</p>\n<p>ちなみにここで<code>(error) DENIED Redis is running in protected mode because protected mode is enabled ~</code>\nというエラーが発生する場合は、下記を参考にしてください。</p>\n<p><a href=\"https://qiita.com/port9/items/94ececff95adaa27b950\">redis で because protected mode is enabled が出た場合の対処 - Qiita</a></p>\n<p><code>redis-cli</code>を使って Redis の中身を確認すると、セッションが保存されているのが確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ redis-cli\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"session:d473262d9ea737183cfea7327c7abb2e\"</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> get session:d473262d9ea737183cfea7327c7abb2e\n<span class=\"token string\">\"<span class=\"token entity\" title=\"\\x04\">\\x04</span><span class=\"token entity\" title=\"\\b\">\\b</span>{<span class=\"token entity\" title=\"\\x06\">\\x06</span>I<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token entity\" title=\"\\x10\">\\x10</span>_csrf_token<span class=\"token entity\" title=\"\\x06\">\\x06</span>:<span class=\"token entity\" title=\"\\x06\">\\x06</span>EFI<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>1OVi9+6AQ8dkLwHvPbYSacBuAgtnkPKp9A+cHUBrYwEQ=<span class=\"token entity\" title=\"\\x06\">\\x06</span>;<span class=\"token entity\" title=\"\\x00\">\\x00</span>F\"</span></code></pre></div>\n<h2><strong>セッションの有効期限を設定する</strong></h2>\n<p>上記の設定だと Redis に溜まったデータが削除されず、メモリが不足してしまいます。</p>\n<blockquote>\n<p>確認したい場合はブラウザの開発ツールで cookie を削除してページにアクセスするのを繰り返してみてください。\n前のセッションが破棄されず Redis に溜まっていくのが確認できます。</p>\n</blockquote>\n<p>先ほど作成した<code>config/initializers/session_store.rb</code>に 1 行追加して、\nセッションの有効期限を設定しましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">RedisRailsSample</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Application</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>session_store <span class=\"token symbol\">:redis_store</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  servers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      host<span class=\"token punctuation\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n      port<span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span><span class=\"token punctuation\">,</span>\n      db<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      namespace<span class=\"token punctuation\">:</span> <span class=\"token string\">\"session\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\"># 以下の行を追記</span>\n  expire_after<span class=\"token punctuation\">:</span> <span class=\"token number\">1.</span>minute<span class=\"token punctuation\">,</span> <span class=\"token comment\"># 本番では1.weekなどにすると良いでしょう</span>\n  key<span class=\"token punctuation\">:</span> <span class=\"token string\">\"_<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>parent_name<span class=\"token punctuation\">.</span>downcase<span class=\"token delimiter tag\">}</span></span>_session\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここでもう一度 Redis と Rails を立ち上げ\n<code>http://localhost:3000/tasks</code>にアクセスしてみると、\n同じようにセッションが保存されていますが、\n今度は有効期限が設定されているのが分かります。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"session:244f74bbe23995aedc7624eeafe2131d\"</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ttl session:244f74bbe23995aedc7624eeafe2131d\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">51</span></code></pre></div>\n<h2><strong>おわりに</strong></h2>\n<p>以上、簡単でしたが<a href=\"https://github.com/redis-store/redis-rails\">redis-store/redis-rails</a>\nを使ってみました。\n次回は有名な認証機能のライブラリである<a href=\"https://github.com/plataformatec/devise\">plataformatec/devise</a>\nと組み合わせた挙動を確認していきたいと思います。</p>","frontmatter":{"title":"RailsのセッションをRedisに保存する (1)","date":"November 10, 2017","tags":["Rails","Redis"],"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABFUlEQVQoz31TQW7CMBD0H3gH/+A9zTO4wwkJhDhxDNCe2qZqT1RI/QFBiKqCAw12CImdIXEDctx1VrKs3fVsZuwJgxV5nt/3XKl6bqyqaMPBnMOkpOtZpntmjR5IMMjWa8jtlgS6asxs3mSWIUYj/LTbEMOhZlWGPBxwmc/BF4/3c7Ur+Ce5OiR3O3y3Wjh1uzpXSaL3jefhizGsipWEYQ1DM6yavN/HpgCJyeSvVzHcBwE+Ox0sHzxc4riZofkQYjDQcnmvB3U8AmkKIQSeXgP4zy+YFpLf3j+gDNmNDM++r4edZzOI8RgqilBCYs5x+o3Ai7z8APXSjLKGeac3uZTnmm1j+80cbFnKtpdbsuOvcJmYiiuTIEv1MpV1wgAAAABJRU5ErkJggg==","width":1200,"height":630,"src":"/static/c48aa04ddbcddd89b86e21a65ec32dca/e7e81/2017-11-10-ogp.png","srcSet":"/static/c48aa04ddbcddd89b86e21a65ec32dca/e7e81/2017-11-10-ogp.png 1x"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/11/redis-rails","previous":{"fields":{"slug":"/2017/10/rails-fluentd"},"frontmatter":{"title":"FluentdでRailsのログをS3に保存する","tags":["Rails","Fluentd"]}},"next":{"fields":{"slug":"/2017/11/redis-rails-2"},"frontmatter":{"title":"RailsのセッションをRedisに保存する (2)","tags":["Rails","Redis"]}}}}}