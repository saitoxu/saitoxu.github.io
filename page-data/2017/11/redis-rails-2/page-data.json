{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/11/redis-rails-2","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"7ebd35ed-0631-51be-bf5c-b83ac37f32ba","excerpt":"前回の記事では Rails のセッションを\nredis-store/redis-rails\nを使って Redis に保存するところまでを試しました。 Rails のセッションを Redis に保存する (1) | yosuke.saito 今回は Rails の認証ライブラリで有名な\nplataformatec…","html":"<p>前回の記事では Rails のセッションを\n<a href=\"https://github.com/redis-store/redis-rails\">redis-store/redis-rails</a>\nを使って Redis に保存するところまでを試しました。</p>\n<p><a href=\"/2017/11/redis-rails\">Rails のセッションを Redis に保存する (1) | yosuke.saito</a></p>\n<p>今回は Rails の認証ライブラリで有名な\n<a href=\"https://github.com/plataformatec/devise\">plataformatec/devise</a>\nと組み合わせたときの挙動を確認してみます。</p>\n<p>Rails のプロジェクトは前回作成したものを引き続き使用します。</p>\n<h2><strong>Devise のインストール</strong></h2>\n<p>まずは Devise をインストールします。Gemfile に<code>gem 'devise'</code>を書いて<code>bundle install</code>を実行します。\n次に Devise の README に従い<code>rails g devise:install</code>を実行し、\n<code>config/environments/development.rb</code>を次のように編集します。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>configure <span class=\"token keyword\">do</span>\n  <span class=\"token comment\"># ...</span>\n\n  <span class=\"token comment\"># 以下を追記</span>\n  config<span class=\"token punctuation\">.</span>action_mailer<span class=\"token punctuation\">.</span>default_url_options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> host<span class=\"token punctuation\">:</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>最後に Devise で認証するモデルを作成します。今回は<code>User</code>モデルとします。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ rails g devise User</code></pre></div>\n<p>これで Devise の準備が完了しました。</p>\n<h2><strong>ログイン機能を足す</strong></h2>\n<p>次に、これまで作成してきた Todo 管理アプリケーションに変更を加え、\nログインしなければタスク一覧などを確認できないようにします。</p>\n<p>まずはルートとなる controller を作成し、</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ rails g controller home index</code></pre></div>\n<p><code>config/routes.rb</code>に<code>root to: 'home#index'</code>を追加します。</p>\n<p>次に、ナビゲーションしやすいように以下のような部分テンプレートを作成し、</p>\n<div class=\"gatsby-highlight\" data-language=\"erb\"><pre class=\"language-erb\"><code class=\"language-erb\"><span class=\"token comment\">&lt;!-- app/views/layouts/_navigation.html.erb --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>nav navbar-nav<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> link_to <span class=\"token string\">'Home'</span><span class=\"token punctuation\">,</span> root_path <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%</span> <span class=\"token keyword\">if</span> current_user <span class=\"token delimiter punctuation\">%></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> link_to <span class=\"token string\">'Task list'</span><span class=\"token punctuation\">,</span> tasks_path <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> link_to <span class=\"token string\">'Settings'</span><span class=\"token punctuation\">,</span> edit_user_registration_path <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> link_to <span class=\"token string\">'Log out'</span><span class=\"token punctuation\">,</span> destroy_user_session_path<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">:</span> <span class=\"token string\">'delete'</span> <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%</span> <span class=\"token keyword\">else</span> <span class=\"token delimiter punctuation\">%></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> link_to <span class=\"token string\">'Login'</span><span class=\"token punctuation\">,</span> new_user_session_path <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> link_to <span class=\"token string\">'Register'</span><span class=\"token punctuation\">,</span> new_user_registration_path <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%</span> <span class=\"token keyword\">end</span> <span class=\"token delimiter punctuation\">%></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><code>app/views/layouts/application.html.erb</code>に追加します。</p>\n<div class=\"gatsby-highlight\" data-language=\"erb\"><pre class=\"language-erb\"><code class=\"language-erb\"><span class=\"token doctype\">&lt;!DOCTYPE html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token comment\">&lt;!-- 以下を追記 --></span>\n    <span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> render <span class=\"token string\">'layouts/navigation'</span> <span class=\"token delimiter punctuation\">%></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>notice<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> notice <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>alert<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> alert <span class=\"token delimiter punctuation\">%></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> <span class=\"token keyword\">yield</span> <span class=\"token delimiter punctuation\">%></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>最後に<code>app/controllers/tasks_controller.rb</code>に 1 行加えてタスクの CRUD にログインを要求するようにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">TasksController</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ApplicationController</span>\n  <span class=\"token comment\"># 以下を追記</span>\n  before_action <span class=\"token symbol\">:authenticate_user!</span>\n\n  <span class=\"token comment\"># ...</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>さて、ここまでで見た目は微妙ですが、一応ログインが必要な Web アプリになりました。</p>\n<h2><strong>挙動の確認</strong></h2>\n<p>ではサーバを起動して、<code>http://localhost:3000/users/sign_up</code>からユーザ登録してみましょう。\nデフォルトであればユーザ名とパスワードを入力するとそのままログインできるはずです。</p>\n<p>ログインに成功したら Redis を確認してみましょう。\nセッションが保存されているのを確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"session:1a502b40f8166de679d543a9684d8b17\"</span></code></pre></div>\n<p>試しにこのセッションを削除してみましょう。キーの削除は<code>del</code>コマンドを使います。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> del session:1a502b40f8166de679d543a9684d8b17\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span></code></pre></div>\n<p>その後ログインが必要なページ、\nたとえば<code>http://localhost:3000/tasks/new</code>などを開こうとすると、\n<code>http://localhost:3000/users/sign_in</code>にリダイレクトされると思います。</p>\n<h2><strong>おわりに</strong></h2>\n<p>以上、<a href=\"https://github.com/redis-store/redis-rails\">redis-store/redis-rails</a>と\n<a href=\"https://github.com/plataformatec/devise\">plataformatec/devise</a>を組み合わせてみました。\n特段引っかかるところもなく簡単に導入できましたね。</p>\n<p>ただ、実環境では Redis の冗長化が必要となることが多いでしょう。\nそこで次回は Redis の死活監視や自動フェイルオーバーを行ってくれる <strong>Redis Sentinel</strong> を使ってみます。</p>","frontmatter":{"title":"RailsのセッションをRedisに保存する (2)","date":"November 13, 2017","tags":["Rails","Redis"],"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABFUlEQVQoz31TQW7CMBD0H3gH/+A9zTO4wwkJhDhxDNCe2qZqT1RI/QFBiKqCAw12CImdIXEDctx1VrKs3fVsZuwJgxV5nt/3XKl6bqyqaMPBnMOkpOtZpntmjR5IMMjWa8jtlgS6asxs3mSWIUYj/LTbEMOhZlWGPBxwmc/BF4/3c7Ur+Ce5OiR3O3y3Wjh1uzpXSaL3jefhizGsipWEYQ1DM6yavN/HpgCJyeSvVzHcBwE+Ox0sHzxc4riZofkQYjDQcnmvB3U8AmkKIQSeXgP4zy+YFpLf3j+gDNmNDM++r4edZzOI8RgqilBCYs5x+o3Ai7z8APXSjLKGeac3uZTnmm1j+80cbFnKtpdbsuOvcJmYiiuTIEv1MpV1wgAAAABJRU5ErkJggg==","width":1200,"height":630,"src":"/static/c48aa04ddbcddd89b86e21a65ec32dca/e7e81/2017-11-10-ogp.png","srcSet":"/static/c48aa04ddbcddd89b86e21a65ec32dca/e7e81/2017-11-10-ogp.png 1x"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/11/redis-rails-2","previous":{"fields":{"slug":"/2017/11/redis-rails"},"frontmatter":{"title":"RailsのセッションをRedisに保存する (1)","tags":["Rails","Redis"]}},"next":{"fields":{"slug":"/2017/11/carrierwave-update"},"frontmatter":{"title":"CarrierWaveでアップロードした画像を後から変更する","tags":["Ruby","Rails"]}}}}}