{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/11/carrierwave-update","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"065fe645-cff2-5b0b-a06d-37f28a16a9dd","excerpt":"CarrierWave を使ってアップロードしたファイルを後から変更したいことがたまにあります。\nたとえば次のような状況です: 最初はアップロードしたファイルのファイル名をそのまま使ってたけど後からファイル名を UUID…","html":"<p>CarrierWave を使ってアップロードしたファイルを後から変更したいことがたまにあります。\nたとえば次のような状況です:</p>\n<ul>\n<li>最初はアップロードしたファイルのファイル名をそのまま使ってたけど後からファイル名を UUID に変更したい</li>\n<li>画像ファイルのサイズが大きすぎると困るので、上限以上だったら適当にリサイズするようにしたい</li>\n</ul>\n<p>こういったとき uploader のソースコードを修正してもこれからアップロードするファイルは修正したとおりになりますが、\nアップロード済みのファイルは修正されません。</p>\n<p>このように、すでにアップロード済みのファイルを修正したいときにどうするか調べました。</p>\n<h2><strong>方法</strong></h2>\n<p>次のように公開されているファイルの URL からファイルを読み込んで保存すると、\n変更が反映されたファイルを保存できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">user <span class=\"token operator\">=</span> <span class=\"token constant\">User</span><span class=\"token punctuation\">.</span>first\nuser<span class=\"token punctuation\">.</span>photo <span class=\"token operator\">=</span> open<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>photo<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\nuser<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span></code></pre></div>\n<p>ただし上記だと問題が発生する場合があるので、実際は次のようにすると良いです。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">user <span class=\"token operator\">=</span> <span class=\"token constant\">User</span><span class=\"token punctuation\">.</span>first\nuser<span class=\"token punctuation\">.</span>photo <span class=\"token operator\">=</span> <span class=\"token constant\">MiniMagick</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Image</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span>open<span class=\"token punctuation\">(</span><span class=\"token constant\">URI</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>photo<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token symbol\">:read</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nuser<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span></code></pre></div>\n<p><code>URI.encode()</code>は元のファイルの URL にマルチバイト文字が含まれている場合に URI エンコードするためです。</p>\n<p><code>MiniMagick::Image.read()</code>ですが、<code>open()</code>は元のファイルのサイズが小さいときに<code>Tempfile</code>クラスではなく<code>StringIO</code>クラスのオブジェクトを返すため、\nCarrierWave 内部でエラーが発生してしまいます。\nそこで<code>MiniMagick::Image.read()</code>を挟むと両者の違いを吸収し CarrierWave で処理できるようになります。</p>","frontmatter":{"title":"CarrierWaveでアップロードした画像を後から変更する","date":"November 23, 2017","tags":["Ruby","Rails"],"ogp":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2017/11/carrierwave-update","previous":{"fields":{"slug":"/2017/11/redis-rails-2"},"frontmatter":{"title":"RailsのセッションをRedisに保存する (2)","tags":["Rails","Redis"]}},"next":{"fields":{"slug":"/2017/12/one-year-summary"},"frontmatter":{"title":"CTOになって1年経ったので雑に振り返ってみる","tags":["Daily","Startup"]}}}}}