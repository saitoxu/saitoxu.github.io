{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016/10/github-twitter-integration-2","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"3af5f503-2e9b-5a5f-a3b9-ee112a371200","excerpt":"I will start from where we left off, in this post,\nI will introduce my small system I mentioned in the previous post. The system works as below. I push a commit…","html":"<p>I will start from where we left off, in this post,\nI will introduce my small system I mentioned in <a href=\"/2016/10/github-twitter-integration\">the previous post</a>.</p>\n<p>The system works as below.</p>\n<ol>\n<li>I push a commit to my blog repository.</li>\n<li>GitHub sends a POST request to my system.</li>\n<li>My system posts a tweet automatically.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e64df342b41a6c3db8210927fbf2d863/3df1e/2016-10-15-figure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.018315018315015%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABQ0lEQVQoz21RTW+CQBTkn/oDami9NPHaH+DNevIkF5seGknP9h80khA5mBYlRWRJASvytbzpLqUWGyeZZN+8fdnZeQoR5VUN4kQQpBMBcNE4q9v81auG8qw0zQaENjjnZ3WapojjGPv9HmIYl6BEYVQaiwV2LJA36Hg8UlmW9DKf0/1wSLZtk7SfJAlpmkbdbpf6/T75jBEvC4qTlEz3QE+vO9pGGSkfjsOv1B6ub3r0FUVgQYDVagVtMoE+m+FhOq2dbTYbjMdjdDodqKoK13Wx8zz4wSfunt9w+2jhkHEoMiP73Ya1tCgTg0VRQjiEJy6bpgnGGPI8h3AIXdcxGAwwGo0QhmGtF0WB5fYAL85+vtzKkGRzvV7DcZxTJpFwbRgGLMuqs2vr8kHf9/82IHJVmk1B5tQOV9Q1/+OSLkerZknf6mcKbSG3ZKYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Figure\"\n        title=\"Figure\"\n        src=\"/static/e64df342b41a6c3db8210927fbf2d863/799d3/2016-10-15-figure.png\"\n        srcset=\"/static/e64df342b41a6c3db8210927fbf2d863/00d96/2016-10-15-figure.png 148w,\n/static/e64df342b41a6c3db8210927fbf2d863/0b23c/2016-10-15-figure.png 295w,\n/static/e64df342b41a6c3db8210927fbf2d863/799d3/2016-10-15-figure.png 590w,\n/static/e64df342b41a6c3db8210927fbf2d863/2a3d6/2016-10-15-figure.png 885w,\n/static/e64df342b41a6c3db8210927fbf2d863/ae92f/2016-10-15-figure.png 1180w,\n/static/e64df342b41a6c3db8210927fbf2d863/3df1e/2016-10-15-figure.png 1365w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As I said at the last time, my system is built by Sinatra, Thin, Nginx.</p>\n<p>First, the app code is below, it’s small.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string\">'sinatra'</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">'twitter'</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">'json'</span>\n\nget <span class=\"token string\">'/'</span> <span class=\"token keyword\">do</span>\n  <span class=\"token string\">'working'</span>\n<span class=\"token keyword\">end</span>\n\npost <span class=\"token string\">'/payload'</span> <span class=\"token keyword\">do</span>\n\n  client <span class=\"token operator\">=</span> <span class=\"token constant\">Twitter</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">REST</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Client</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">do</span> <span class=\"token operator\">|</span>config<span class=\"token operator\">|</span>\n    config<span class=\"token punctuation\">.</span>consumer_key        <span class=\"token operator\">=</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string\">'TWITTER_CONSUMER_KEY'</span><span class=\"token punctuation\">]</span>\n    config<span class=\"token punctuation\">.</span>consumer_secret     <span class=\"token operator\">=</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string\">'TWITTER_CONSUMER_SECRET'</span><span class=\"token punctuation\">]</span>\n    config<span class=\"token punctuation\">.</span>access_token        <span class=\"token operator\">=</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string\">'TWITTER_ACCESS_TOKEN'</span><span class=\"token punctuation\">]</span>\n    config<span class=\"token punctuation\">.</span>access_token_secret <span class=\"token operator\">=</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string\">'TWITTER_ACCESS_TOKEN_SECRET'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">end</span>\n  count <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  prefix <span class=\"token operator\">=</span> <span class=\"token string\">'POST:'</span>\n  commits <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'commits'</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">if</span> commits\n    <span class=\"token keyword\">for</span> commit <span class=\"token keyword\">in</span> commits <span class=\"token keyword\">do</span>\n      message <span class=\"token operator\">=</span> commit<span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">if</span> message<span class=\"token punctuation\">.</span>start_with<span class=\"token operator\">?</span><span class=\"token punctuation\">(</span>prefix<span class=\"token punctuation\">)</span>\n        title <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>sub<span class=\"token punctuation\">(</span><span class=\"token regex\">/#{prefix}/</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip\n        addedFiles <span class=\"token operator\">=</span> commit<span class=\"token punctuation\">[</span><span class=\"token string\">'added'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">for</span> added <span class=\"token keyword\">in</span> addedFiles <span class=\"token keyword\">do</span>\n          <span class=\"token keyword\">if</span> md <span class=\"token operator\">=</span> added<span class=\"token punctuation\">.</span>match<span class=\"token punctuation\">(</span><span class=\"token regex\">/([0-9]{4})-([0-9]{2})-([0-9]{2})-(.*).md/</span><span class=\"token punctuation\">)</span>\n            year  <span class=\"token operator\">=</span> md<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n            month <span class=\"token operator\">=</span> md<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n            day   <span class=\"token operator\">=</span> md<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n            page  <span class=\"token operator\">=</span> md<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">'.html'</span>\n            url <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://saitoxu.io'</span><span class=\"token punctuation\">,</span> year<span class=\"token punctuation\">,</span> month<span class=\"token punctuation\">,</span> day<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n\n            client<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>title <span class=\"token operator\">+</span> <span class=\"token string\">\"\\n\"</span> <span class=\"token operator\">+</span> url<span class=\"token punctuation\">)</span>\n            count <span class=\"token operator\">+</span><span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n          <span class=\"token keyword\">end</span>\n        <span class=\"token keyword\">end</span>\n      <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n  <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>count<span class=\"token delimiter tag\">}</span></span> tweet(s) posted.\"</span>\n\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>To use Twitter API, we need some authentications,\nso I stored them as environment variables.</p>\n<p>Next, a config file of thin server is like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">chdir</span><span class=\"token punctuation\">:</span> /var/lib/github<span class=\"token punctuation\">-</span>twitter<span class=\"token punctuation\">-</span>integration\n<span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span> production\n<span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10080</span>\n<span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n<span class=\"token key atrule\">log</span><span class=\"token punctuation\">:</span> log/production.log\n<span class=\"token key atrule\">pid</span><span class=\"token punctuation\">:</span> tmp/pids/thin.pid\n<span class=\"token key atrule\">max_conns</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1024</span>\n<span class=\"token key atrule\">max_persistent_conns</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n<span class=\"token key atrule\">require</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token key atrule\">wait</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n<span class=\"token key atrule\">threadpool_size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span>\n<span class=\"token key atrule\">socket</span><span class=\"token punctuation\">:</span> /tmp/thin.sock\n<span class=\"token key atrule\">daemonize</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>Finally, Nginx’s config is as below.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">user</span> <span class=\"token keyword\">root</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">worker_processes</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">events</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">worker_connections</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">http</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">upstream</span> thin <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">server</span> unix<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>tmp<span class=\"token operator\">/</span>thin<span class=\"token punctuation\">.</span>sock<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">listen</span> <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">server_name</span> example<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">location</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>thin<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we can start this server by the following commands.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ bundle <span class=\"token builtin class-name\">exec</span> thin -C config/thin.yml\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx start</code></pre></div>\n<p>GitHub Webhook and Twitter API are easy to use,</p>\n<p>please use this post as reference and try to use them!</p>\n<p>Sample code: <a href=\"https://github.com/saitoxu/github-twitter-integration\">GitHub Twitter integration</a></p>","frontmatter":{"title":"GitHub and Twitter integration (2)","date":"October 15, 2016","tags":["Twitter","Ruby","Sinatra","GitHub","Thin","Nginx"],"ogp":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2016/10/github-twitter-integration-2","previous":{"fields":{"slug":"/2016/10/github-twitter-integration"},"frontmatter":{"title":"GitHub and Twitter integration","tags":["Twitter","Ruby","Sinatra","GitHub"]}},"next":{"fields":{"slug":"/2016/10/soft-skills"},"frontmatter":{"title":"SOFT SKILLS","tags":["Book"]}}}}}