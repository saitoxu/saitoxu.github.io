{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016/10/how-to-create-nodejs-addons","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"a9f84929-92b0-53ab-931a-ac411036624d","excerpt":"We can create Node.js Addons written in C/C++. See the following page for more detail. Addons | Node.js v6.7.0 Documentation In this post, I’ll introduce how to…","html":"<p>We can create Node.js Addons written in C/C++.</p>\n<p>See the following page for more detail.</p>\n<p><a href=\"https://nodejs.org/dist/latest-v6.x/docs/api/addons.html\">Addons | Node.js v6.7.0 Documentation</a></p>\n<p>In this post, I’ll introduce how to create factorial method addon.\nFinally, we can use the method like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>addon<span class=\"token punctuation\">.</span><span class=\"token function\">factorial</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 120</span></code></pre></div>\n<h4><strong>Step 1</strong></h4>\n<p>First, Set up npm project.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> init</code></pre></div>\n<h4><strong>Step 2</strong></h4>\n<p>Install following packages.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g node-gyp\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save nan\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> bindings <span class=\"token comment\"># optional</span></code></pre></div>\n<p><code>node-gyp</code> is a native addon build tool for Node.js.\nNode.js addons depend on V8 JavaScript Engine, so\nwhen V8 is updated, you may also need to update your addon.</p>\n<p><code>nan</code> module removes addon dependency on V8,\nwe don’t need to consider backward compatibility.</p>\n<p><code>bindings</code> is helper module for loading your native module’s .node file.</p>\n<h4><strong>Step 3</strong></h4>\n<p>Create a <em>binding.gyp</em> file with the following content.\nThis is needed for build C/C++ program, and NAN needs <em>include</em>dirs_.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"targets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"target_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"factorial\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"factorial.cc\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"include_dirs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"&lt;!(node -e \\\"require('nan')\\\")\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4><strong>Step 4</strong></h4>\n<p>Create <code>factorial.cc</code> like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;nan.h></span></span>\n\n<span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> v8<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">factorial</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">NAN_METHOD</span><span class=\"token punctuation\">(</span>Factorial<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>info<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">IsNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> info<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">NumberValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Nan<span class=\"token operator\">::</span><span class=\"token function\">ThrowTypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Wrong argument\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  info<span class=\"token punctuation\">.</span><span class=\"token function\">GetReturnValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token function\">factorial</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">NumberValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">NAN_MODULE_INIT</span><span class=\"token punctuation\">(</span>init<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Nan<span class=\"token operator\">::</span><span class=\"token function\">SetMethod</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"factorial\"</span><span class=\"token punctuation\">,</span> Factorial<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">NODE_MODULE</span><span class=\"token punctuation\">(</span>factorial<span class=\"token punctuation\">,</span> init<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">factorial</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">factorial</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are 3 important modules.</p>\n<p><code>NAN_METHOD</code> is an implementation of method.</p>\n<p><code>NAN_MODULE_INIT</code> registers the method.</p>\n<p><code>NODE_MODULE</code> is entry point for this addon,\nthe first argument must be same as <code>target_name</code> in <em>binding.gyp</em>.</p>\n<h4><strong>Step 5</strong></h4>\n<p>Build the code by the following command.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ node-gyp configure build</code></pre></div>\n<p>Then <em>factorial.node</em> is created in <em>build/Release</em> directory.</p>\n<h4><strong>Step 6</strong></h4>\n<p>Write some JavaScript code.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> addon <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bindings\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"factorial.node\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// const addon = require('./build/Release/addon'); // no bindings module</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>addon<span class=\"token punctuation\">.</span><span class=\"token function\">factorial</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 3628800</span></code></pre></div>\n<p>I put the above code on GitHub repository: <a href=\"https://github.com/saitoxu/nodejs-addon-sample\">Node.js Addon Sample</a></p>\n<p>Thanks for reading, following steps are written in here.</p>\n<p><a href=\"https://github.com/nodejs/node-addon-examples\">nodejs/node-addon-examples: Node.js C++ addon examples from http://nodejs.org/docs/latest/api/addons.html</a></p>","frontmatter":{"title":"How to create C/C++ Addons of Node.js","date":"October 08, 2016","tags":["JavaScript","Node.js","C","C++"],"ogp":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2016/10/how-to-create-nodejs-addons","previous":{"fields":{"slug":"/2016/10/introduction"},"frontmatter":{"title":"Introduction","tags":["Daily"]}},"next":{"fields":{"slug":"/2016/10/machine-learning-sample-programs"},"frontmatter":{"title":"Sample programs of Machine Learning","tags":["JavaScript","Machine Learning"]}}}}}