{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016/12/speech-recognition-api-3","result":{"data":{"site":{"siteMetadata":{"title":"saitoxu.io","siteUrl":"https://saitoxu.io"}},"ogp":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjElEQVQoz82STQoDIQyF5/5HUVcuFNfeRdyIohvx7xWFllJm2llMaQOPhJiEj8QNF9v21YFjjIc/o+eeQ8LXgne2V7tLWGtFSgnWWhhjVhxjRM4Z3vul3vtnwvujcw6UUhBCoJQCYwxCCEgpobUG5xwhhPMDpy+lLIqpSdxaW4QzP+Pf7vDSK//dx74BXyBi+B0nsZEAAAAASUVORK5CYII=","width":1200,"height":630,"src":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png","srcSet":"/static/bb302f3ca7aabb14b0ae74df1c534526/e7e81/ogp.png 1x"}}},"markdownRemark":{"id":"55445668-74c1-55bf-88e3-6554a959c361","excerpt":"This is continued article of the previous post. This time, we will finally implement the speech recognition part. Step 9 The method to recognize speech is as…","html":"<p>This is continued article of <a href=\"/2016/12/speech-recognition-api-2\">the previous post</a>.</p>\n<p>This time, we will finally implement the speech recognition part.</p>\n<h4><strong>Step 9</strong></h4>\n<p>The method to recognize speech is as below.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">UIKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">Speech</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">UIViewController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function\">startRecording</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">refreshTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">let</span> audioSession <span class=\"token operator\">=</span> <span class=\"token builtin\">AVAudioSession</span><span class=\"token punctuation\">.</span><span class=\"token function\">sharedInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">try</span> audioSession<span class=\"token punctuation\">.</span><span class=\"token function\">setCategory</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">AVAudioSessionCategoryRecord</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">try</span> audioSession<span class=\"token punctuation\">.</span><span class=\"token function\">setMode</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">AVAudioSessionModeMeasurement</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">try</span> audioSession<span class=\"token punctuation\">.</span><span class=\"token function\">setActive</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> with<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>notifyOthersOnDeactivation<span class=\"token punctuation\">)</span>\n\n        recognitionRequest <span class=\"token operator\">=</span> <span class=\"token function\">SFSpeechAudioBufferRecognitionRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> inputNode <span class=\"token operator\">=</span> audioEngine<span class=\"token punctuation\">.</span>inputNode <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">fatalError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Audio engine has no input node\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> recognitionRequest <span class=\"token operator\">=</span> recognitionRequest <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">fatalError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to created a SFSpeechAudioBufferRecognitionRequest object\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n        recognitionRequest<span class=\"token punctuation\">.</span>shouldReportPartialResults <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n        recognitionTask <span class=\"token operator\">=</span> speechRecognizer<span class=\"token punctuation\">.</span><span class=\"token function\">recognitionTask</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> recognitionRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">weak</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span> result<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> `<span class=\"token keyword\">self</span>` <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">var</span> isFinal <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> result <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>bestTranscription<span class=\"token punctuation\">.</span>formattedString\n                isFinal <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>isFinal\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> error <span class=\"token operator\">!=</span> <span class=\"token constant\">nil</span> <span class=\"token operator\">||</span> isFinal <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>audioEngine<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                inputNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeTap</span><span class=\"token punctuation\">(</span>onBus<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>recognitionRequest <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>recognitionTask <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>startBtn<span class=\"token punctuation\">.</span>isEnabled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>startBtn<span class=\"token punctuation\">.</span><span class=\"token function\">setTitle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Start\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> recordingFormat <span class=\"token operator\">=</span> inputNode<span class=\"token punctuation\">.</span><span class=\"token function\">outputFormat</span><span class=\"token punctuation\">(</span>forBus<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        inputNode<span class=\"token punctuation\">.</span><span class=\"token function\">installTap</span><span class=\"token punctuation\">(</span>onBus<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> bufferSize<span class=\"token punctuation\">:</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> format<span class=\"token punctuation\">:</span> recordingFormat<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AVAudioPCMBuffer</span><span class=\"token punctuation\">,</span> when<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AVAudioTime</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>recognitionRequest<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token function\">startAudioEngine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function\">refreshTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> recognitionTask <span class=\"token operator\">=</span> recognitionTask <span class=\"token punctuation\">{</span>\n            recognitionTask<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>recognitionTask <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function\">startAudioEngine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n        audioEngine<span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">try</span> audioEngine<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span></code></pre></div>\n<h4><strong>Step 10</strong></h4>\n<p>Call the above <code>startRecording()</code> method when tapping the start button.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">UIKit</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">Speech</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewController</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">UIViewController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token atrule\">@IBAction</span> <span class=\"token keyword\">func</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> sender<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> audioEngine<span class=\"token punctuation\">.</span>isRunning <span class=\"token punctuation\">{</span>\n            audioEngine<span class=\"token punctuation\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            recognitionRequest<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">endAudio</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            startBtn<span class=\"token punctuation\">.</span>isEnabled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n            startBtn<span class=\"token punctuation\">.</span><span class=\"token function\">setTitle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Stopping\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>disabled<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span><span class=\"token operator\">!</span> <span class=\"token function\">startRecording</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            startBtn<span class=\"token punctuation\">.</span><span class=\"token function\">setTitle</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Clear\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span></code></pre></div>\n<h4><strong>Step 11</strong></h4>\n<p>That’s it!</p>\n<p>Please run the app and speak something.\nYour voice will be recognized, and the content will be displayed as text.</p>\n<p>It was a bit long, thank you for reading to the end.</p>","frontmatter":{"title":"Speech Recognition API (3)","date":"December 09, 2016","tags":["Swift","iOS","Xcode"],"ogp":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2016/12/speech-recognition-api-3","previous":{"fields":{"slug":"/2016/12/speech-recognition-api-2"},"frontmatter":{"title":"Speech Recognition API (2)","tags":["Swift","iOS","Xcode"]}},"next":{"fields":{"slug":"/2016/12/back-propagation"},"frontmatter":{"title":"Back Propagation","tags":["JavaScript","Machine Learning"]}}}}}